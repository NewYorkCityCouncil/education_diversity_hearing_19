---
title: "School diversity hearing"
author: "Nick Solomon and James Subudhi"
date: '`r councildown::pretty_date()`'
output: 
  councildown::council_html: default
  councildown::council_pdf:
    latex_engine: xelatex
compact-title: true
fontsize: 11pt
subparagraph: yes
---

```{r include = FALSE}
library(ggplot2)
library(councildown)
library(scales)

extrafont::loadfonts()
knitr::knit_hooks$set(embed = hook_pdfembed)
knitr::opts_chunk$set(echo = FALSE, embed = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r load-data}
source("code/00_load_data.R")
```


# City Overview

This section contains facts about all schools and students in New York City that were included in the 2017 committee report. All data is for the 2017-18 school year.

## Race and Ethnicity

```{r}
citywide <- read_excel("data/original_data/demographicsnapshot201314to201718public_final.xlsx", sheet = "Citywide") %>% 
  clean_names()

cols <- c("#706AE0", "#16AC9E", "#F59F00", "#CB5871", "#82C91E")

citywide %>% 
  filter(year == "2017-18") %>% 
  select(number_asian,
         number_black,
         number_hispanic,
         number_multiple_race_categories_not_represented,
         number_white) %>%
  gather("race", "number") %>%
  mutate(prop = number/sum(number)) %>%
  mutate(race = str_remove(race, "number_") %>%
           str_replace_all("_", " ") %>%
           str_to_sentence() %>%
           str_wrap(width = 30) %>% 
           reorder(-number)) %>% 
  ggplot(aes(race, prop)) +
  geom_col(aes(fill = race), show.legend = FALSE) +
  geom_text(aes(label = paste0(number(number,big.mark = ","), " (", percent(prop) ,")")),
            family = "Times New Roman",
            vjust = -.5) +
  scale_fill_manual(values = cols) +
  scale_y_continuous(labels = percent_format(accuracy = 1), expand = expand_scale(mult = .05, add = c(0, .01))) +
  theme_nycc(print = TRUE) +
  labs(title = "Demographic breakdown of New York City Public Schools",
       subtitle = "For the 2017-18 school year",
       x = "Race/ethnicity",
       y = "Percent of students",
       caption = "Source: DOE Demographic Snapshot")
```



```{r}
num_black_hispanic_less_10_white <- school_dems %>% 
  filter(year == "2017-18", percent_white < .1, !str_detect(dbn, "^84")) %>% 
  summarize(number_black = sum(number_black),
            number_hispanic = sum(number_hispanic)) %>% 
  mutate(total = number_black + number_hispanic) %>% 
  pull(total)

num_black_hispanic <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84")) %>% 
  summarize(number_black = sum(number_black),
            number_hispanic = sum(number_hispanic)) %>% 
  mutate(total = number_black + number_hispanic) %>% 
  pull(total)


num_white_more_50_white <- school_dems %>% 
  filter(year == "2017-18", percent_white > .5, !str_detect(dbn, "^84")) %>% 
  summarize(number_white = sum(number_white)) %>% 
  pull(number_white)

num_white <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84")) %>% 
  summarize(number_white = sum(number_white)) %>% 
  pull(number_white)

```

- `r percent(num_black_hispanic_less_10_white/num_black_hispanic)` of black and Hispanic students attend a school that is less than 10% white students.
- `r percent(num_white_more_50_white/num_white)` of white students attend a school with more than 50% white students

```{r}
more_75_poverty_race <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84"), percent_poverty > .75) %>% 
  summarize_at(vars(starts_with("number_")), sum) %>% 
  select(number_asian,
         number_black,
         number_hispanic,
         number_multiple_race_categories_not_represented,
         number_white)

num_race <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84")) %>% 
  summarize_at(vars(starts_with("number_")), sum) %>% 
  select(number_asian,
         number_black,
         number_hispanic,
         number_multiple_race_categories_not_represented,
         number_white)

 

dat <- (more_75_poverty_race/num_race) %>% 
  gather("race", "prop") %>% 
  mutate(race = str_remove(race, "number_") %>%
           str_replace_all("_", " ") %>%
           str_to_sentence() %>%
           str_wrap(width = 30) %>% 
           reorder(-prop))
cols <- c("#706AE0", "#16AC9E", "#F59F00", "#82C91E", "#CB5871")
names(cols) <- levels(dat$race)
  
ggplot(dat, aes(race, prop)) +
  geom_col(aes(fill = race), show.legend = FALSE) +
  scale_fill_manual(values = cols) + 
   geom_text(aes(label = percent(prop)),
            family = "Times New Roman",
            vjust = -.5) +
  scale_y_continuous(labels = percent_format(accuracy = 1), expand = expand_scale(mult = .05, add = c(0, .01))) +
  labs(title = "Percentage of students attending a school where\nmore than 75% of students experience poverty",
       x = "Race/ethnicity",
       y = "Percent of students",
       caption = "Source: DOE Demographic Snapshot") + 
  theme_nycc(print = TRUE)
```

## Poverty

```{r include = FALSE}
city_pov <- citywide %>% 
  filter(year == "2017-18") %>% 
  pull(percent_poverty)

city_eni <- citywide %>% 
  filter(year == "2017-18") %>% 
  pull(economic_need_index)
```


- Citywide, `r percent(city_pov)` of students experience poverty. The citywide Economic Need Index is `r percent(city_eni)`.

## ELL Students

```{r}
num_more_20_ell <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84"), percent_english_language_learners > .2) %>% 
  nrow()
num_less_10_ell <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84"), percent_english_language_learners < .1) %>% 
  nrow()

num_schools <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84")) %>% 
  nrow()
```

- `r percent(num_more_20_ell/num_schools)` of schools have a population of more than 20% ELL students
- `r percent(num_less_10_ell/num_schools)` of schools have a population of less than 10% ELL students

## Students With Disabilities

- `r citywide %>% filter(year == "2017-18") %>% pull(percent_students_with_disabilities) %>% percent()` of students in New York City are students with disabilities.

```{r}
num_less_10_dis <- school_dems %>% 
  filter(year == "2017-18", !str_detect(dbn, "^84"), percent_students_with_disabilities < .1) %>% 
  nrow()
```

- `r percent(num_less_10_dis/num_schools)` of schools have a population that is less than 10% students with disabilities.

## Students in temporary housing

```{r}
diversity_report_k8 <- read_excel("data/original_data/17-18_report.xlsx", sheet = "Grades K-8 School") %>% 
  clean_names()

diversity_report_912 <- read_excel("data/original_data/17-18_report.xlsx", sheet = "Grades 9-12 School") %>% 
  clean_names()

all_temp_housing <- bind_rows(diversity_report_912, diversity_report_k8) %>% 
  filter(category == "Students in temporary housing", !str_detect(dbn, "^84")) %>%
  select(dbn, temp_housing = total_enrollment) %>%
  mutate(temp_housing = parse_number(temp_housing)) %>% 
  group_by(dbn) %>% 
  summarize(temp_housing = sum(temp_housing, na.rm = TRUE))

total_enrollment <- bind_rows(diversity_report_912, diversity_report_k8) %>% 
  filter(category == "All Students", !str_detect(dbn, "^84")) %>%
  select(dbn, total_enrollment) %>%
  mutate(total_enrollment = parse_number(total_enrollment)) %>% 
  group_by(dbn) %>% 
  summarize(total_enrollment = sum(total_enrollment, na.rm = TRUE))

perc_more_15_temp_housing <- total_enrollment %>% 
  left_join(all_temp_housing, by = "dbn") %>% 
  mutate(perc_temp_housing = temp_housing/total_enrollment) %>%
  replace_na(list(perc_temp_housing = 0)) %>% 
  summarize(mean(perc_temp_housing > .15, na.rm = TRUE)) %>% 
  pull()

perc_no_temp_housing <- total_enrollment %>% 
  left_join(all_temp_housing, by = "dbn") %>% 
  mutate(perc_temp_housing = temp_housing/total_enrollment) %>% 
  summarize(mean(perc_temp_housing == 0, na.rm = TRUE)) %>% 
  pull()
```


- `r percent(perc_more_15_temp_housing)` of schools have a population of more than 15% of students in temporary housing.
- `r percent(perc_no_temp_housing)` of schools do not have any students in temporary housing.

# Specialized High School Diversity

Specialized high schools have been an important part of the conversation around school diversity and integration in New York City. The graphic below shows the racial demographics of 8 of the 9 specialized high schools. LaGuardia High School is not show here as it has auditions based admissions. Clearly, severe discrepancies exist for those given access to the highest level of academic achievement New York City has to offer.

```{r fig.asp=1}
source("code/shs_diversity.R")
shs_demo_plot
```


## Poverty in Specialized High Schools

```{r}
school_dems %>%
  filter(dbn %in% shs, year == "2017-18") %>%
  select(school_name,
        percent_poverty, economic_need_index) %>% 
  mutate_if(is.numeric, percent) %>% 
  knitr::kable(col.names = c("School", "Percent of Students Experiencing Poverty", "Economic Need Index"))
```


<!-- ## Specialized High School Fair Student Funding -->

<!-- ```{r} -->
<!-- shs_fsf <- data.frame(stringsAsFactors=FALSE, -->
<!--                       School = c("Stuyvesant HS", -->
<!--                                  "Brooklyn Tech", -->
<!--                                  "Bronx Science", "Brooklyn Latin", -->
<!--                                  "Staten Island Tech", -->
<!--                                  "Queens HS for Sciences", -->
<!--                                  "HS of American Studies", "HSMSE"), -->
<!--                       FY19.Per.Capita = c("$1,020.68", "$1,020.68", -->
<!--                                           "$1,020.68", "$1,020.68", -->
<!--                                           "$1,020.68", "$1,020.68",  -->
<!--                                           "$1,020.68", "$1,020.68"), -->
<!--                       FY19.Enrollment = c(3298, 5970, 3004, 616, 1335, -->
<!--                                           473, 409, 512), -->
<!--                       Specialized.Academic.FSF.100 = c("$3,366,211", "$6,093,475", -->
<!--                                                        "$3,066,131", "$628,741", -->
<!--                                                        "$1,362,611", "$482,783", "$417, -->
<!--                                                   459", "$522,590"), -->
<!--                       FSF.percent = c("96.66%", "90.00%", -->
<!--                                       "90.00%", "100.41%", -->
<!--                                       "97.44%", "106.67%", "113.85%", -->
<!--                                       "121.25%"), -->
<!--                       Specialized.Academic.Spending.Given.FSF = c("$3,253,780", "$5,484,128", -->
<!--                                                                   "$2,759,518", "$631,319", -->
<!--                                                                   "$1,327,728", "$514,985", "$475, -->
<!--                                                   277", "$633,640") -->
<!-- ) %>%  -->
<!--   mutate_at(vars(-School, -FY19.Enrollment), parse_number) %>%  -->
<!--   mutate(FSF.percent = FSF.percent/100, -->
<!--          per_capita_given_fsf = FY19.Per.Capita * FSF.percent, -->
<!--          School = reorder(School, -per_capita_given_fsf)) -->


<!-- ggplot(shs_fsf, aes(School, per_capita_given_fsf)) +  -->
<!--   geom_col() + -->
<!--   scale_y_continuous(labels = dollar) + -->
<!--   labs(title = "Per capita \"Specialized Academic\" funding", -->
<!--        subtitle = "Accounting for the FSF funding level of each school", -->
<!--        x = "School", -->
<!--        y = "\"Specialized Academic\" funding") + -->
<!--   theme_nycc(print = TRUE) + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) -->

<!-- ``` -->


# Elementary School Diversity and Geography

Below is a plot showing the racial and ethnic demographics of two co-located elementary schools in District 1. Despite being in literally the same location, these two schools exhibit very different demographics. What decisions made by the school, the district, or the Department of Education have lead to this discrepancy?


```{r include = FALSE}
star_pov <- school_dems %>% 
  filter(str_detect(school_name, "STAR Academy .*63"), year == "2017-18") %>% 
  pull(percent_poverty)
star_eni <- school_dems %>% 
  filter(str_detect(school_name, "STAR Academy .*63"), year == "2017-18") %>% 
  pull(economic_need_index)

nbhd_pov <- school_dems %>% 
  filter(str_detect(school_name, "Neighborhood School"), str_detect(dbn, "M"), year == "2017-18") %>% 
  pull(percent_poverty)
nbhd_eni <- school_dems %>% 
  filter(str_detect(school_name, "Neighborhood School"), str_detect(dbn, "M"), year == "2017-18") %>% 
  pull(economic_need_index)
```


```{r fig.asp = .5, fig.height=4, fig.cap = "Segregated and integrated schools are often very close to one another. These two elementary schools are co-located in the same building, but one is much more segregated than the other."}
source("code/elem_school_maps.R")
plots[[1]]
```

The STAR Academy is predominately black and Hispanic, with fewer than 20% white students. The Neighborhood school, on the other hand is more than 40% white. What could cause such a discrepancy? Furthermore, these schools show differences in demographics beyond race. In the 2017-18 school year, The STAR Academy, which is predominantly Hispanic and black, had an economic need index of `r percent(star_eni)` and the DOE classified `r percent(star_pov)` of its students as experiencing poverty. In comparison, during the same year The Neighborhood School had an economic need index of `r percent(nbhd_eni)` and `r percent(nbhd_pov)` of its students experienced poverty. These schools are divided not just along racial lines but along socio-economic lines.


<!-- # Middle School Segregation -->

<!-- This map shows the locations of DOE managed middle schools (where a middle school is any school with a 6th grade) in the city. The shading reflects how racially representative the school is, with darker colors deviating more significantly from the overall frequency distribution of races in New York City middle schools. Clicking on any one of the schools shows the racial breakdown of the school. -->

<!-- ```{r cache = TRUE} -->
<!-- source("code/map_middle_school_div.R") -->
<!-- # diversity_map -->
<!-- ``` -->

<!-- One area in particular shows a startling difference between schools that are very close together. These two schools are close together near the Park Slope neighborhood of Brooklyn -->

<!-- ```{r} -->
<!-- # plots_all_vars <- school_divs %>% -->
<!-- #   left_join(plots, by = "dbn") -->
<!-- #  -->
<!-- # plots_all_vars %>%  -->
<!-- #   filter(str_detect(school_name, "M.S. 51")) %>%  -->
<!-- #   pull(plots) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # plots_all_vars %>%  -->
<!-- #   filter(str_detect(school_name, "The Math & Science")) %>%  -->
<!-- #   pull(plots) -->
<!-- ``` -->

<!-- Across Flatbush Avenue, these schools in Prospect heights look very different. -->

<!-- ```{r} -->
<!-- # plots_all_vars %>%  -->
<!-- #   filter(str_detect(school_name, "I.S. 340")) %>%  -->
<!-- #   pull(plots) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # plots_all_vars %>%  -->
<!-- #   filter(str_detect(school_name, "Elijah Stroud")) %>%  -->
<!-- #   pull(plots) -->
<!-- ``` -->


<!-- What DOE policies and procedures and neighborhood demographic and economic characteristics lead to such a discrepancy between schools only a short walk from one another? -->

